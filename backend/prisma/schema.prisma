// Prisma schema for AI Trader
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String   // bcrypt hashed
  role      UserRole @default(TRADER)
  status    UserStatus @default(ACTIVE)
  
  // Exchange Credentials (encrypted)
  asterApiKey      String?
  asterApiSecret   String?
  asterTestnet     Boolean @default(true)
  
  // AI Provider Keys
  deepseekApiKey   String?
  openaiApiKey     String?
  anthropicApiKey  String?
  geminiApiKey     String?

  // Agent Model Configuration (deepseek | openai | anthropic | gemini)
  marketAnalystModel    String @default("deepseek")
  riskOfficerModel      String @default("deepseek")
  strategyConsultantModel String @default("deepseek")
  orchestratorModel       String @default("deepseek")
  
  // Trading Preferences
  preferredExchange String @default("aster")
  marketType        String @default("perp")  // perp | spot
  methodology       String @default("SMC")   // SMC | ICT | Gann | Custom
  selectedPairs     Json?  // ["BTC-USD", "ETH-USD"]
  leverage          Int    @default(10)
  
  // Risk Parameters
  maxPositionSize       Float  @default(5)   // % of portfolio per position
  maxRiskPerTrade       Float  @default(2)   // % of portfolio risk per trade
  tradingCapitalPercent Float  @default(10)  // % of total capital to use for trading
  maxDrawdownPercent    Float  @default(15)  // Max allowed drawdown before stopping
  
  // Trading Controls
  tradingEnabled       Boolean @default(false)
  tradingMode          String  @default("signal") // signal | trade | test
  strategyMode         String  @default("deepseek") // deepseek | rl | hybrid
  disclaimerAccepted   Boolean @default(false)
  disclaimerAcceptedAt DateTime?
  termsAccepted        Boolean @default(false)
  termsAcceptedAt      DateTime?
  
  // Subscription (BYOK = Bring Your Own Key)
  subscriptionPlan     SubscriptionPlan @default(FREE)
  subscriptionStatus   SubscriptionStatus @default(ACTIVE)
  subscriptionEndsAt   DateTime?
  
  // Onboarding
  onboardingStep      Int     @default(0)
  onboardingCompleted Boolean @default(false)
  
  // Relations
  sessions         UserSession[]
  trades           Trade[]
  signals          Signal[]
  agentDecisions   AgentDecision[]
  strategyVersions StrategyVersion[]
  trackedSignals   TrackedSignal[]
  testSessions     TestSession[]
  backtestSessions BacktestSession[]
  tradingModels    TradingModel[]
  subscriptions    Subscription[]
  payments         PaymentHistory[]
  
  // Analysis Caching
  lastMarketAnalysisAt DateTime?
  lastMarketAnalysis   Json?     // Cached market analysis result
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  @@index([email])
  @@index([username])
  @@index([subscriptionPlan])
}

enum UserRole {
  ADMIN
  TRADER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model UserSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================
// TRADING
// ============================================

model Trade {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  symbol        String
  side          String   // LONG | SHORT
  entryPrice    Float
  exitPrice     Float?
  quantity      Float
  leverage      Int
  
  pnl           Float?
  pnlPercent    Float?
  
  status        TradeStatus @default(OPEN)
  methodology   String   // SMC | ICT | Gann
  strategyMode  String   @default("deepseek") // deepseek | rl
  
  // Agent that triggered the trade
  agentDecisionId String?
  
  openedAt      DateTime @default(now())
  closedAt      DateTime?
  
  @@index([userId])
  @@index([symbol])
  @@index([status])
}

enum TradeStatus {
  OPEN
  CLOSED
  CANCELLED
}

model Signal {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  symbol          String
  direction       String   // LONG | SHORT | HOLD
  confidence      Float
  methodology     String
  strategyMode    String   @default("deepseek") // deepseek | rl
  
  entryPrice      Float?
  stopLoss        Float?
  takeProfit      Float?
  
  status          SignalStatus @default(ACTIVE)
  
  // Link to agent decision
  agentDecisionId String?
  
  // Backtest flag
  isBacktest      Boolean @default(false)
  backtestSessionId String?
  
  // Source mode: BACKTEST | SIGNAL | TRADE
  sourceMode      String @default("SIGNAL")
  
  createdAt       DateTime @default(now())
  executedAt      DateTime?
  
  @@index([userId])
  @@index([symbol])
  @@index([status])
}

enum SignalStatus {
  ACTIVE
  EXECUTED
  HIT_TP      // Take profit was hit
  HIT_SL      // Stop loss was hit
  EXPIRED
  CANCELLED
}

// ============================================
// STRATEGY EVOLUTION
// ============================================

model StrategyVersion {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  version         Int
  baseMethodology String   // SMC | ICT | Gann | Custom
  rules           Json     // StrategyRule[]
  learnings       Json     // string[] - COT learnings
  metrics         Json     // Performance metrics
  
  active          Boolean  @default(false) // Changed default to false, rely on status
  status          StrategyStatus @default(DRAFT)
  lastTestedAt    DateTime?
  backtestCompleted Boolean @default(false)  // Must be true before TESTED
  parentVersionId String?  // For tracking evolution chain
  
  trackedSignals  TrackedSignal[]
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([active])
  @@index([version])
  @@index([status])
}

enum StrategyStatus {
  DRAFT
  TESTED
  ACTIVE
  ARCHIVED
}

model TrackedSignal {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  strategyVersionId String?
  strategyVersion   StrategyVersion? @relation(fields: [strategyVersionId], references: [id])
  
  symbol          String
  direction       String   // LONG | SHORT
  entryPrice      Float
  stopLoss        Float
  takeProfit      Float
  confidence      Float
  
  // Agent reasoning (all 3 agents)
  agentReasoning  Json     // { strategyConsultant, riskOfficer, marketAnalyst }
  
  // Market snapshot at signal time
  indicatorsSnapshot Json?
  
  // Tracking status
  status          String   @default("PENDING") // PENDING | HIT_TP | HIT_SL | EXPIRED | CANCELLED
  actualOutcome   String?  // WIN | LOSS | BREAKEVEN
  pnlPercent      Float?
  priceAtClose    Float?
  
  // Execution info (if traded)
  executed        Boolean  @default(false)
  orderId         String?
  executionPrice  Float?
  realizedPnL     Float?
  
  createdAt       DateTime @default(now())
  closedAt        DateTime?
  expiresAt       DateTime?
  
  @@index([userId])
  @@index([strategyVersionId])
  @@index([status])
  @@index([symbol])
}

model TestSession {
  id                  String   @id @default(uuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id])
  
  status              String   @default("RUNNING") // RUNNING | STOPPED | COMPLETED
  
  initialStrategyId   String
  currentStrategyId   String
  
  // Performance tracking
  signalCount         Int      @default(0)
  winCount            Int      @default(0)
  lossCount           Int      @default(0)
  totalPnLPercent     Float    @default(0)
  
  // Evolution tracking
  evolutionCount      Int      @default(0)
  
  startedAt           DateTime @default(now())
  endedAt             DateTime?
  
  @@index([userId])
  @@index([status])
}

// ============================================
// AI AGENTS
// ============================================

model AgentDecision {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  agentType       AgentType
  
  // Chain of Thought (COT)
  reasoning       String   @db.Text  // Full COT reasoning
  thoughtSteps    Json     // Array of thought steps
  
  // Decision
  decision        String   // LONG | SHORT | HOLD | MODIFY_RL | RETRAIN | STOP_RL
  confidence      Float
  
  // Context
  symbol          String?
  marketData      Json?    // Market data at decision time
  
  // RL Control (for StrategyConsultant)
  rlAction        String?  // modify_params | retrain | stop
  rlParams        Json?    // Modified parameters
  
  // Backtest flag
  isBacktest      Boolean @default(false)
  backtestSessionId String?
  
  // Source mode: BACKTEST | SIGNAL | TRADE
  sourceMode      String @default("SIGNAL")
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([agentType])
  @@index([createdAt])
  @@index([isBacktest])
}

enum AgentType {
  STRATEGY_CONSULTANT
  RISK_OFFICER
  MARKET_ANALYST
  ORCHESTRATOR
}

// ============================================
// RL SERVICE TRACKING
// ============================================

model RLModelStatus {
  id              String   @id @default(uuid())
  
  modelName       String
  algorithm       String   @default("SAC") // PPO | SAC | A2C
  
  // Performance Metrics
  sharpeRatio     Float?
  totalReturn     Float?
  maxDrawdown     Float?
  winRate         Float?
  
  // Training Status
  trainingStatus  String   @default("idle") // idle | training | stopped
  lastTrainedAt   DateTime?
  totalTimesteps  Int      @default(0)
  
  // Current Parameters
  hyperparams     Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([modelName])
}

// ============================================
// BACKTESTING (Backend-Driven)
// ============================================

model BacktestSession {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  strategyVersionId String
  
  // Configuration
  symbol            String
  initDate          DateTime
  endDate           DateTime
  initialCapital    Float
  
  // Progress
  status            BacktestStatus  @default(PENDING)
  currentDate       DateTime?
  currentStep       Int     @default(0)
  totalSteps        Int     @default(0)
  
  // Results
  portfolioValue    Float?
  portfolioHistory  Json?   // Array of {date, value}
  trades            Json?   // Array of simulated trades
  
  // Metrics (calculated on completion)
  totalReturn       Float?
  maxDrawdown       Float?
  winRate           Float?
  sharpeRatio       Float?
  
  createdAt         DateTime @default(now())
  completedAt       DateTime?
  
  @@index([userId])
  @@index([strategyVersionId])
  @@index([status])
}

enum BacktestStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

// ============================================
// TRADING MODELS (Cost-Efficient Agent Architecture)
// ============================================

model TradingModel {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  // Version & Identity
  version         Int
  name            String?
  methodology     String   // SMC | ICT | Gann | Custom
  
  // Multi-Timeframe Configuration
  timeframes      String[] // ["5m", "15m", "1h", "4h"]
  
  // Model Parameters (entry/exit rules, indicators)
  parameters      Json     // Strategy rules, thresholds, etc.
  
  // Backtest Results
  backtestResults Json?
  sharpeRatio     Float?
  winRate         Float?
  maxDrawdown     Float?
  totalReturn     Float?
  
  // Lifecycle Status
  status          TradingModelStatus @default(DRAFT)
  approvedBy      String[] // ["STRATEGY_CONSULTANT", "RISK_OFFICER", "MARKET_ANALYST"]
  
  // Active Model Tracking
  isActive        Boolean  @default(false)
  currentDrawdown Float    @default(0)
  
  // Linked Strategy Version (if derived from one)
  strategyVersionId String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  activatedAt     DateTime?
  expiresAt       DateTime?  // + 1 month by default
  retiredAt       DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([isActive])
}

enum TradingModelStatus {
  DRAFT           // Initial creation
  BACKTESTING     // Running backtest
  PENDING_APPROVAL // Awaiting counsel approval
  APPROVED        // Approved but not yet active
  ACTIVE          // Currently in use
  RETRAINING      // 15% drawdown triggered retrain
  RETIRED         // Replaced by newer model
}

// ============================================
// POSITION TRACKING
// ============================================

model Position {
  id            String   @id @default(uuid())
  userId        String
  symbol        String
  side          String   // LONG | SHORT
  
  // Entry
  entryPrice    Float
  size          Float
  
  // Current State
  currentPrice  Float?
  unrealizedPnl Float?
  unrealizedPnlPercent Float?
  
  // Exit Targets
  stopLoss      Float?
  takeProfit    Float?
  trailingStop  Float?   // % distance
  
  // Exit
  exitPrice     Float?
  realizedPnl   Float?
  realizedPnlPercent Float?
  closeReason   String?  // HIT_TP | HIT_SL | MANUAL | LIQUIDATED
  
  // Status
  status        String   @default("OPEN") // OPEN | CLOSED | LIQUIDATED
  
  // Linked Signal
  signalId      String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  closedAt      DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([symbol])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  
  type      String   // TRADE_EXECUTED | SIGNAL_GENERATED | TP_HIT | SL_HIT | DRAWDOWN_WARNING
  title     String
  message   String
  data      String?  // JSON stringified
  
  read      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([read])
}

// ============================================
// SUBSCRIPTION & PAYMENTS (NOWPayments Crypto)
// ============================================

enum SubscriptionPlan {
  FREE      // Limited features, demo mode
  PRO       // $25/month - Bring Your Own Key (BYOK)
  CUSTOM    // Enterprise - We provide LLM keys
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  plan            SubscriptionPlan
  status          SubscriptionStatus @default(PENDING)
  
  // NOWPayments Integration
  paymentId       String?   // NOWPayments payment ID
  invoiceId       String?   // NOWPayments invoice ID
  invoiceUrl      String?   // Payment URL for user
  
  amount          Float     // Amount in crypto
  currency        String    // BTC, ETH, USDT, etc.
  amountUsd       Float     // USD equivalent
  
  // Subscription Period
  startDate       DateTime?
  endDate         DateTime?
  
  // First signal tracking (for refund policy)
  firstSignalAt   DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([paymentId])
}

model PaymentHistory {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // NOWPayments Data
  paymentId       String   @unique  // NOWPayments payment ID
  invoiceId       String?
  orderId         String?  // Our internal order reference
  
  // Amounts
  amount          Float    // Original amount
  actuallyPaid    Float?   // Amount actually received
  currency        String   // Crypto currency used
  amountUsd       Float    // USD equivalent at payment time
  
  // Status
  status          PaymentStatus @default(PENDING)
  
  // Metadata
  payAddress      String?  // Crypto address for payment
  network         String?  // Blockchain network
  metadata        Json?    // Full NOWPayments response
  
  createdAt       DateTime @default(now())
  confirmedAt     DateTime?
  
  @@index([userId])
  @@index([paymentId])
  @@index([status])
}

enum PaymentStatus {
  PENDING       // Waiting for payment
  CONFIRMING    // Payment detected, waiting confirmations
  CONFIRMED     // Payment confirmed
  SENDING       // We're processing
  FINISHED      // Complete
  FAILED        // Payment failed
  EXPIRED       // Invoice expired
  REFUNDED      // Refunded (only before first signal)
}
